<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: filterPage.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: filterPage.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

/** 
 * Namespace for localBi classes and functions.
 * @namespace
 */
var localBi = localBi || {};

/** 
 * Builds an HTML page with embedded data, script and markup. Can be mailed to multiple recipients.
 * @method
 * @param {tableRow[]} tableData - Two dimensional array representing a table (recordset).
 * @param {object[]} tableData[tableRow] - Each row is an array of {string/number}.
 * @returns {string} A string containing JS code that can be appended to a script.
 */
localBi.filterPage = function() {

    /** 
     * Builds a normalised set of fields and records from a denormalised table. Each field is scanned and only unique values stored in each filterField. Each record is scanned and only a reference to the field value is stored in each filterRecord.
     * @method
     * @param {tableRow[]} tableData - Two dimensional array representing a table (recordset).
     * @param {object[]} tableData[tableRow] - Each row is an array of {string/number}.
     * @returns {string} A string containing JS code that can be appended to a script.
     */
    function normaliseTable(tableData) {
        let normalisedFields = [];
        let normalisedRecords = [];
        for (let colIndex = 0; colIndex &lt; tableData[0].length; colIndex++) {  //use table header as basis for number of columns

            let fieldName = tableData[0][colIndex];
            let fieldIsFound = false;  //to check if filterField exists
            let fieldIndex = 0;  //position of found filterField
            while (fieldIsFound == false &amp;&amp; fieldIndex &lt; normalisedFields.length) {  //search until we can confirm it doesn't exist in the list - use while so we can exit early
                if(fieldName == normalisedFields[fieldIndex][0]) fieldIsFound = true;
                else fieldIndex++;
            }
            if (fieldIsFound == false) {
                normalisedFields[fieldIndex] = [];  //new array for values
                normalisedFields[fieldIndex][0] = fieldName;  //first index is the fieldname
            }
            let normalisedValues = normalisedFields[fieldIndex];  //assign either existing or new array

            for (let rowIndex = 0; rowIndex &lt; tableData.length; rowIndex++) {  //table data start at row 1

                let valueName = tableData[rowIndex][colIndex];
                let valueIsFound = false;  //to check if filterValue exists
                let valueIndex = 0;  //position of found filterValue
                while (valueIsFound == false &amp;&amp; valueIndex &lt; normalisedValues.length) {  //search until we can confirm it doesn't exist in the list - use while so we can exit early
                    if (valueName == normalisedValues[valueIndex]) valueIsFound = true;
                    else valueIndex++;
                }
                if (valueIsFound == false) normalisedValues[valueIndex] = valueName;  //define filterValue because it wasn't found, and valueIndex will be at the next open slot already to be added

                if (colIndex == 0) normalisedRecords[rowIndex] = [];  //assign blank array the first time
                normalisedRecords[rowIndex][colIndex] = valueIndex;  //assign index of value - assume colIndex is persistent
            }
        }
        let result = 'var fields=' + JSON.stringify(normalisedFields) + ';';
        result += '\nvar records=' + JSON.stringify(normalisedRecords).replace('"','') + ';';  //numeric keys, the quotes take up lotsa space so we remove them
        return result;
    }

    function mailPage(mailSpecification) {  //mail page to recipients
        let nodemailer = require('nodemailer');

        let transporter = nodemailer.createTransport({  // create reusable transporter object using the default SMTP transport
            service: 'gmail',
            auth: {
                user: mailSpecification.user,
                pass: mailSpecification.pass                }
        });

        let mailOptions = {  // setup email data with unicode symbols
            from: mailSpecification.from, // sender address
            to: mailSpecification.to, // list of receivers
            subject: mailSpecification.subject, // Subject line
            text: mailSpecification.text, // plain text body
            attachments: [
                {   // stream as an attachment
                    filename: mailSpecification.filename,
                    content: mailSpecification.content
                }]
        };

        transporter.sendMail(mailOptions, (error, info) => {  // send mail with defined transport object
            if (error) {
                return console.log(error);
            }
            console.log('Sent: %s', info.accepted);
        });
    }

    function buildPage(fileName) {  //build complete html page
        let fs = require("fs");
        let parse = require('csv-parse/lib/sync');

        let csvData = parse(fs.readFileSync('filterData.csv'), {delimiter: ','});
        fs.writeFileSync('filterData.js', normaliseTable(csvData));
        
        let combinedScripts = fs.readFileSync('./filterIndex.html').toString()  //combine scripts and styles into single html file
        .replace('&lt;link rel="stylesheet" href="filterStyle.css">','&lt;style>' + fs.readFileSync('filterStyle.css') + '&lt;/style>')
        .replace(' src="chart.min.js">',  '>\n' + fs.readFileSync('chart.min.js'))
        .replace(' src="filterTable.js">', '>\n' + fs.readFileSync('filterTable.js'))
        .replace(' src="filterData.js">', '>\n' + fs.readFileSync('filterData.js'))
        .replace(' src="filterChart.js">', '>\n' + fs.readFileSync('filterChart.js'));

        fs.writeFileSync(fileName, combinedScripts);
        return combinedScripts;
    }

    {  //main
        let fs = require("fs");
        let parse = require('csv-parse/lib/sync');
        let mailData = parse(fs.readFileSync('filterMail.csv'), {delimiter: ','});
        let mailContent = buildPage('localBi.html')
        /*
        for (let mailIndex = 1; mailIndex &lt; mailData.length; mailIndex++) {  //skip header
            mailPage({
                user: mailData[mailIndex][mailData[0].indexOf('user')],
                pass: mailData[mailIndex][mailData[0].indexOf('pass')],
                from: mailData[mailIndex][mailData[0].indexOf('from')],
                to: mailData[mailIndex][mailData[0].indexOf('to')],
                subject: mailData[mailIndex][mailData[0].indexOf('subject')],
                text: mailData[mailIndex][mailData[0].indexOf('text')],
                filename: 'localBi.html',
                content: mailContent
            });
        }
        */
    }
}

//run with: "node filterPage.js"
localBi.filterPage();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="localBi.filterTable.html">filterTable</a></li></ul><h3>Namespaces</h3><ul><li><a href="localBi.html">localBi</a></li></ul><h3>Global</h3><ul><li><a href="global.html#aggregate">aggregate</a></li><li><a href="global.html#filter">filter</a></li><li><a href="global.html#findField">findField</a></li><li><a href="global.html#findValue">findValue</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Sep 18 2018 08:46:25 GMT+0200 (South Africa Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
